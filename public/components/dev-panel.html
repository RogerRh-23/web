<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Dev</title>
  <link rel="stylesheet" href="/public/styles/main.css">
  <link rel="icon" type="image/png" href="/public/assets/img/LACS-V.png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    @media (max-width: 991.98px) {
      #footer { margin-bottom: 90px !important; }
      .main-content-navbar-padding { padding-top: 0 !important; }
    }
    @media (min-width: 992px) {
      .main-content-navbar-padding { padding-top: 70px; }
    }
  </style>
</head>
<body>
  <div id="navbar-container"></div>
  <div id="navbar-mobile-placeholder"></div>
  <main class="main-content-navbar-padding">
    <section class="dev-panel-section">
      <h2>Panel de Desarrollador</h2>
      <div class="dev-panel-actions">
        <button id="btn-logout-dev" class="btn btn-danger"><i class="bi bi-box-arrow-right"></i> Cerrar sesión dev</button>
      </div>
      <div class="dev-panel-cards">
        <div class="dev-panel-card">
          <h3><i class="bi bi-archive"></i> Certificados cargados</h3>
          <button id="btn-refresh-certs" class="btn btn-secondary"><i class="bi bi-arrow-clockwise"></i> Actualizar</button>
          <div id="certs-count" class="dev-certs-count">Cargando...</div>
        </div>
        <div class="dev-panel-card">
          <h3><i class="bi bi-person-plus"></i> Crear Administrador</h3>
          <form id="create-admin-form">
            <label for="username">Usuario</label>
            <input type="text" id="username" name="username" required autocomplete="off">
            <label for="email">Correo electrónico</label>
            <input type="email" id="email" name="email" required autocomplete="off">
            <label for="password">Contraseña</label>
            <input type="password" id="password" name="password" required>
            <button type="submit" class="btn btn-success"><i class="bi bi-person-plus"></i> Crear Administrador</button>
          </form>
          <div class="msg" id="msg-create-admin"></div>
        </div>
        <div class="dev-panel-card">
          <h3><i class="bi bi-person"></i> Ver usuarios actuales</h3>
          <button id="btn-list-users" class="btn btn-primary"><i class="bi bi-list"></i> Listar usuarios</button>
          <ul id="users-list" class="dev-users-list"></ul>
        </div>
        <div class="dev-panel-card">
          <h3><i class="bi bi-shield-lock"></i> Probar token actual</h3>
          <button id="btn-check-token" class="btn btn-info"><i class="bi bi-shield-check"></i> Ver datos de mi token</button>
          <div id="token-info" class="dev-token-info"></div>
        </div>
        <div class="dev-panel-card">
          <h3><i class="bi bi-clipboard-data"></i> Registro de logs</h3>
          <button id="btn-refresh-logs" class="btn btn-secondary"><i class="bi bi-arrow-clockwise"></i> Actualizar logs</button>
          <ul id="dev-logs-list" class="dev-logs-list"></ul>
        </div>
      </div>
    </section>
  </main>
  <div id="footer"></div>
  <script src="/public/js/dev-admin-create.js"></script>
  <script>
    // Carga dinámica de navbar, navbar-mobile y footer
    function loadExternalScript(src, callback) {
      var script = document.createElement('script');
      script.src = src;
      script.async = false;
      script.onload = function() {
        if (typeof callback === 'function') callback();
      };
      document.body.appendChild(script);
    }
    function loadNavbar(type) {
      const url = type === 'mobile' ? './navbar-mobile.html' : './navbar.html';
      fetch(url)
        .then(res => res.text())
        .then(html => {
          html = html.replace(/src=(['"])(\.{0,2}\/)?assets\/img\//g, 'src=$1/src/assets/img/');
          const containerId = type === 'mobile' ? 'navbar-mobile-placeholder' : 'navbar-container';
          document.getElementById(containerId).innerHTML = html;
          const navbarLinks = document.querySelectorAll(`#${containerId} a`);
          navbarLinks.forEach(link => {
            if (link.href.includes('/components/components/')) {
              link.href = link.href.replace('/components/components/', '/components/');
            }
          });
          if (!window._navbarDropdownLoaded) {
            window._navbarDropdownLoaded = true;
            loadExternalScript('../../js/navbar-dropdown.js', function() {
              if (typeof window.initDropdowns === 'function') window.initDropdowns();
            });
          } else {
            if (typeof window.initDropdowns === 'function') window.initDropdowns();
          }
        });
    }
    function isMobile() {
      return window.innerWidth < 992;
    }
    window.addEventListener('resize', function() {
      if (isMobile()) loadNavbar('mobile');
      else document.getElementById('navbar-mobile-placeholder').innerHTML = '';
    });
    window.addEventListener('DOMContentLoaded', function() {
      if (isMobile()) loadNavbar('mobile');
      else loadNavbar('desktop');
      fetch('./footer.html')
        .then(res => res.text())
        .then(html => {
          html = html.replace(/src=(['"])(\.{0,2}\/)?assets\/img\//g, 'src=$1/src/assets/img/');
          document.getElementById('footer').innerHTML = html;
          const footerLinks = document.querySelectorAll('#footer a');
          footerLinks.forEach(link => {
            if (link.href.includes('/components/components/')) {
              link.href = link.href.replace('/components/components/', '/components/');
            }
          });
          loadExternalScript('../../js/footer.js', function() {
            if (typeof window.initFooter === 'function') window.initFooter();
          });
        });
    });

    // Funcionalidad extra para el panel dev
    document.addEventListener('DOMContentLoaded', function() {
      // Crear admin
      const form = document.getElementById('create-admin-form');
      const msg = document.getElementById('msg-create-admin');
      if (form) {
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          msg.textContent = '';
          msg.className = 'msg';
          const username = form.username.value.trim();
          const password = form.password.value;
          const devToken = localStorage.getItem('dev_token');
          if (!devToken) {
            msg.textContent = 'No hay token de desarrollador. Inicia sesión como dev.';
            msg.classList.add('error');
            return;
          }
          try {
            const res = await fetch('/auth/create-admin', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + devToken
              },
              body: JSON.stringify({ username, password })
            });
            const data = await res.json();
            if (res.ok) {
              msg.textContent = data.msg || 'Administrador creado correctamente.';
              msg.classList.add('success');
              form.reset();
            } else {
              msg.textContent = data.detail || 'Error al crear administrador.';
              msg.classList.add('error');
            }
          } catch (err) {
            msg.textContent = 'Error de red o servidor.';
            msg.classList.add('error');
          }
        });
      }
      // Listar usuarios (solo simulado, ya que users_db es local en backend)
      const btnListUsers = document.getElementById('btn-list-users');
      const usersList = document.getElementById('users-list');
      if (btnListUsers && usersList) {
        btnListUsers.addEventListener('click', async function() {
          usersList.innerHTML = '';
          const devToken = localStorage.getItem('dev_token');
          if (!devToken) {
            usersList.innerHTML = '<li class="msg error">No hay token de desarrollador.</li>';
            return;
          }
          try {
            const res = await fetch('/auth/me', {
              headers: { 'Authorization': 'Bearer ' + devToken }
            });
            const data = await res.json();
            if (res.ok) {
              usersList.innerHTML = `<li><b>Usuario actual:</b> ${data.user} <span class="badge bg-info">${data.role}</span></li>`;
              // Aquí podrías mostrar más usuarios si el backend lo permitiera
            } else {
              usersList.innerHTML = `<li class="msg error">${data.detail || 'No autorizado.'}</li>`;
            }
          } catch (err) {
            usersList.innerHTML = '<li class="msg error">Error de red o servidor.</li>';
          }
        });
      }
      // Probar token actual
      const btnCheckToken = document.getElementById('btn-check-token');
      const tokenInfo = document.getElementById('token-info');
      if (btnCheckToken && tokenInfo) {
        btnCheckToken.addEventListener('click', async function() {
          tokenInfo.textContent = '';
          const devToken = localStorage.getItem('dev_token');
          if (!devToken) {
            tokenInfo.textContent = 'No hay token de desarrollador.';
            tokenInfo.className = 'msg error';
            return;
          }
          try {
            const res = await fetch('/auth/me', {
              headers: { 'Authorization': 'Bearer ' + devToken }
            });
            const data = await res.json();
            if (res.ok) {
              tokenInfo.textContent = `Usuario: ${data.user} | Rol: ${data.role}`;
              tokenInfo.className = 'msg success';
            } else {
              tokenInfo.textContent = data.detail || 'Token inválido.';
              tokenInfo.className = 'msg error';
            }
          } catch (err) {
            tokenInfo.textContent = 'Error de red o servidor.';
            tokenInfo.className = 'msg error';
          }
        });
      }
      // Certificados cargados
      const btnRefreshCerts = document.getElementById('btn-refresh-certs');
      const certsCount = document.getElementById('certs-count');
      async function fetchCertsCount() {
        certsCount.textContent = 'Cargando...';
        const devToken = localStorage.getItem('dev_token');
        if (!devToken) {
          certsCount.textContent = 'No hay token de desarrollador.';
          certsCount.className = 'msg error';
          return;
        }
        try {
          const res = await fetch('/certificados', {
            headers: { 'Authorization': 'Bearer ' + devToken }
          });
          const data = await res.json();
          if (res.ok && Array.isArray(data)) {
            certsCount.textContent = `Total: ${data.length} certificados`;
            certsCount.className = 'msg success';
          } else {
            certsCount.textContent = data.detail || 'No autorizado.';
            certsCount.className = 'msg error';
          }
        } catch (err) {
          certsCount.textContent = 'Error de red o servidor.';
          certsCount.className = 'msg error';
        }
      }
      if (btnRefreshCerts && certsCount) {
        btnRefreshCerts.addEventListener('click', fetchCertsCount);
        fetchCertsCount();
      }
      // Logs dev
      const btnRefreshLogs = document.getElementById('btn-refresh-logs');
      const logsList = document.getElementById('dev-logs-list');
      async function fetchLogs() {
        logsList.innerHTML = '<li>Cargando logs...</li>';
        const devToken = localStorage.getItem('dev_token');
        if (!devToken) {
          logsList.innerHTML = '<li class="msg error">No hay token de desarrollador.</li>';
          return;
        }
        try {
          const res = await fetch('/auth/dev-logs', {
            headers: { 'Authorization': 'Bearer ' + devToken }
          });
          const data = await res.json();
          if (res.ok && Array.isArray(data)) {
            if (data.length === 0) {
              logsList.innerHTML = '<li>No hay logs recientes.</li>';
            } else {
              logsList.innerHTML = data.map(log => `<li><b>[${log.timestamp}]</b> <span class="log-action">${log.action}</span> <span class="log-user">${log.user || ''}</span> <span class="log-detail">${log.detail || ''}</span></li>`).join('');
            }
          } else {
            logsList.innerHTML = `<li class="msg error">${data.detail || 'No autorizado.'}</li>`;
          }
        } catch (err) {
          logsList.innerHTML = '<li class="msg error">Error de red o servidor.</li>';
        }
      }
      if (btnRefreshLogs && logsList) {
        btnRefreshLogs.addEventListener('click', fetchLogs);
        fetchLogs();
      }
      // Logout dev
      const btnLogoutDev = document.getElementById('btn-logout-dev');
      if (btnLogoutDev) {
        btnLogoutDev.addEventListener('click', function() {
          localStorage.removeItem('dev_token');
          window.location.reload();
        });
      }
    });
  </script>
</body>
</html>
