<div class="navbar-content">
  <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
    <div class="container-fluid">
      <span class="navbar-brand">
        <img src="/static/assets/img/LACS.png" alt="LACS Logo" />
      </span>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="/static/index.html"><i
                class="bi bi-house-door"></i> <span data-i18n="navbar.home">Inicio</span></a></li>
          <li class="nav-item"><a class="nav-link" data-dropdown="services"><i class="bi bi-briefcase"></i> <span
                data-i18n="navbar.services" data-route="Servicios/">Servicios</span></a></li>
          <li class="nav-item"><a class="nav-link" data-dropdown="processes"><i class="bi bi-diagram-3"></i> <span
                data-i18n="navbar.processes" data-route="Procesos/">Procesos</span></a></li>
          <li class="nav-item"><a class="nav-link" data-dropdown="training"><i class="bi bi-mortarboard"></i>
              <span data-i18n="navbar.training" data-route="CentroFormacion/">Centro de formación</span></a>
          </li>
          <li class="nav-item"><a class="nav-link" href="/static/components/certificados.html"><i
                class="bi bi-award"></i>
              <span data-i18n="navbar.certificates" data-route="certificados.html">Certificados</span></a>
          </li>
          <li class="nav-item"><a class="nav-link" href="/static/components/contacto.html"><i
                class="bi bi-envelope"></i> <span data-i18n="navbar.contact"
                data-route="contacto.html">Contacto</span></a></li>
          <li id="dev-panel-link" class="nav-item" style="display:none;"><a class="nav-link btn btn-warning text-dark"
              href="/static/components/dev-panel.html"><i class="bi bi-tools"></i> <span>Panel Dev</span></a></li>
          <li class="nav-item navbar-actions">
            <button id="lang-switcher" class="btn-lang-switcher" type="button" aria-label="Cambiar idioma">
              <i class="bi bi-translate"></i> EN
            </button>
            <div class="auth-wrapper" style="display:inline-block; position:relative;">
              <a id="auth-btn" class="btn btn-outline-light" href="/static/components/login.html"><i
                  class="bi bi-person-circle"></i>
                <span data-i18n="navbar.login" data-route="login.html">Iniciar Sesión</span></a>
              <div id="auth-dropdown" class="auth-dropdown-menu"
                style="display:none; position:absolute; min-width:160px; background:#fff; color:#000; box-shadow:0 4px 10px rgba(0,0,0,.12); border-radius:6px; padding:6px 0; z-index:2500;">
                <!-- Items populated dynamically -->
              </div>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </nav>
</div>
<script>
  // Sincroniza el texto del botón de idioma con el idioma actual
  function updateLangBtn() {
    var btn = document.getElementById('lang-switcher');
    if (!btn || !window.i18next) return;
    var current = window.i18next.language || 'es';
    btn.innerHTML = '<i class="bi bi-translate"></i> ' + (current === 'en' ? 'ES' : 'EN');
  }
  function showDevPanelLinkIfDev() {
    var devLink = document.getElementById('dev-panel-link');
    try {
      var user = JSON.parse(localStorage.getItem('user'));
      console.log('[Navbar] Detected user:', user);
      if (user && user.role === 'dev') {
        devLink.style.display = '';
        console.log('[Navbar] Dev panel link shown.');
      } else {
        devLink.style.display = 'none';
        console.log('[Navbar] Dev panel link hidden.');
      }
    } catch (e) {
      devLink.style.display = 'none';
      console.log('[Navbar] Error parsing user from localStorage:', e);
    }
  }

  // La función updateAuthButton está definida en navbar-init.js para evitar duplicación

  // Escuchar cambios de localStorage desde otras pestañas
  window.addEventListener('storage', function (e) {
    if (e.key === 'user') updateAuthButton();
  });
  if (window.i18next) {
    window.i18next.on('languageChanged', updateLangBtn);
    document.addEventListener('DOMContentLoaded', function () {
      updateLangBtn();
      showDevPanelLinkIfDev();
      if (typeof window.updateAuthButton === 'function') window.updateAuthButton();
    });
    setTimeout(function () {
      updateLangBtn();
      showDevPanelLinkIfDev();
      if (typeof window.updateAuthButton === 'function') window.updateAuthButton();
    }, 100);
  }

  // En caso de que i18next no esté presente, igualmente actualizamos al cargar
  document.addEventListener('DOMContentLoaded', function () {
    if (typeof window.updateAuthButton === 'function') window.updateAuthButton();
    showDevPanelLinkIfDev();
  });
  setTimeout(function () {
    if (typeof window.updateAuthButton === 'function') window.updateAuthButton();
    showDevPanelLinkIfDev();
  }, 100);

  // ------------------------------
  // Dropdown de autenticación
  // ------------------------------
  var _authDropdownOpen = false;
  function clearAuthDropdown() {
    var dd = document.getElementById('auth-dropdown');
    if (!dd) return;
    dd.innerHTML = '';
  }

  function prepareAuthDropdown(user) {
    var dd = document.getElementById('auth-dropdown');
    if (!dd) return;
    clearAuthDropdown();
    // Opción Cerrar sesión
    var logoutItem = document.createElement('button');
    logoutItem.className = 'dropdown-item';
    logoutItem.style.cssText = 'display:block;border:none;background:transparent;width:100%;text-align:left;padding:8px 12px;cursor:pointer;';
    logoutItem.textContent = 'Cerrar sesión';
    logoutItem.addEventListener('click', function (e) {
      e.preventDefault();
      doLogout();
    });
    // Añadir opción de DevPanel si rol === 'dev'
    if (user && user.role === 'dev') {
      var devItem = document.createElement('a');
      devItem.className = 'dropdown-item';
      devItem.style.cssText = 'display:block;padding:8px 12px;color:inherit;text-decoration:none;';
      devItem.href = '/static/components/dev-panel.html';
      devItem.textContent = 'Panel Dev';
      dd.appendChild(devItem);
    }
    dd.appendChild(logoutItem);
  }

  function onAuthBtnClick(e) {
    var user = null;
    try { user = JSON.parse(localStorage.getItem('user')); } catch (err) { user = null; }
    if (!user) return; // dejar la navegación por defecto si no hay usuario
    e.preventDefault();
    toggleAuthDropdown();
  }

  function toggleAuthDropdown() {
    var dd = document.getElementById('auth-dropdown');
    var btn = document.getElementById('auth-btn');
    if (!dd || !btn) return;
    if (_authDropdownOpen) {
      dd.style.display = 'none';
      _authDropdownOpen = false;
      return;
    }
    // posicionar dropdown debajo del botón
    var rect = btn.getBoundingClientRect();
    // colocar a la derecha del botón si está muy a la izquierda
    dd.style.minWidth = Math.max(140, rect.width) + 'px';
    dd.style.left = (rect.left + window.scrollX) + 'px';
    dd.style.top = (rect.bottom + window.scrollY + 6) + 'px';
    dd.style.display = 'block';
    _authDropdownOpen = true;
    // cerrar al hacer click fuera
    setTimeout(function () {
      window.addEventListener('click', onWindowClickClose);
      window.addEventListener('resize', closeAuthDropdown);
      window.addEventListener('scroll', closeAuthDropdown);
      window.addEventListener('keydown', onKeyDownAuthDropdown);
    }, 0);
  }

  function closeAuthDropdown() {
    var dd = document.getElementById('auth-dropdown');
    if (!dd) return;
    dd.style.display = 'none';
    _authDropdownOpen = false;
    window.removeEventListener('click', onWindowClickClose);
    window.removeEventListener('resize', closeAuthDropdown);
    window.removeEventListener('scroll', closeAuthDropdown);
    window.removeEventListener('keydown', onKeyDownAuthDropdown);
  }

  function onWindowClickClose(e) {
    var dd = document.getElementById('auth-dropdown');
    var btn = document.getElementById('auth-btn');
    if (!dd || !btn) return;
    if (dd.contains(e.target) || btn.contains(e.target)) return;
    closeAuthDropdown();
  }

  function onKeyDownAuthDropdown(e) {
    if (e.key === 'Escape') closeAuthDropdown();
  }

  function doLogout() {
    try {
      localStorage.removeItem('user');
      localStorage.removeItem('token');
      localStorage.removeItem('dev_token');
    } catch (e) {
      console.log('[Navbar] logout error:', e);
    }
    closeAuthDropdown();
    // Actualizar la UI dinámicamente sin recargar
    try {
      if (typeof window.updateAuthButton === 'function') window.updateAuthButton();
      if (typeof showDevPanelLinkIfDev === 'function') showDevPanelLinkIfDev();
      if (typeof window.initDropdowns === 'function') window.initDropdowns();
    } catch (e) {
      console.log('[Navbar] error updating UI after logout:', e);
      // fallback a recarga si algo falla (muy raro)
      window.location.reload();
    }
  }

  function removeAuthBtnBehavior() {
    var btn = document.getElementById('auth-btn');
    if (!btn) return;
    btn.setAttribute('href', '/static/components/login.html');
    try { btn.removeEventListener('click', onAuthBtnClick); } catch (e) { }
    closeAuthDropdown();
  }
</script>